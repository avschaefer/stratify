<div class="space-y-8 animate-fade-in">
  
  <!-- Coinbase-style Header & Actions -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
    <div>
      <h2 class="text-5xl font-medium text-gray-900 tracking-tight"><%= number_to_currency(@portfolio_value, precision: 2) %></h2>
      <div class="flex items-center mt-2 text-sm font-medium text-gray-500">
        <% 
           # Determine color based on sign
           change_amount = @annual_return_amount || 0
           change_percent = @annual_return_percent || 0
           is_positive = change_amount >= 0
           color_class = is_positive ? 'text-emerald-600' : 'text-red-600'
           icon_name = is_positive ? 'arrow_up_right' : 'arrow_down_right'
        %>
        <span class="<%= color_class %> flex items-center mr-2">
          <%= icon(icon_name, size: 16, class: "mr-1") %> 
          <%= number_to_currency(change_amount.abs) %> (<%= change_percent.abs %>%)
        </span>
        <span>YTD</span>
      </div>
    </div>
    
    <div class="flex gap-3">
      <button class="btn-primary">Add Trade</button>
      <button class="btn-secondary">Add Holding</button>
    </div>
  </div>

  <!-- Summary Metrics -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <%= ui_card class: "p-6" do %>
      <p class="text-gray-500 text-sm font-medium">Realized Gains</p>
      <h2 class="text-3xl font-bold text-gray-900 mt-2"><%= number_to_currency(@realized_net, precision: 2) %></h2>
      <p class="text-sm text-gray-400 mt-1">From <%= @trades&.select { |t| t.trade_type == 'sell' }&.count || 0 %> trades this year</p>
    <% end %>

    <%= ui_card class: "p-6" do %>
      <p class="text-gray-500 text-sm font-medium">Benchmark (S&P 500)</p>
      <div class="flex items-baseline gap-2 mt-2">
        <h2 class="text-3xl font-bold text-gray-900"><%= @total_return_percent&.round(1) %>%</h2>
        <span class="text-sm text-gray-400">vs <%= @sp500_return %>%</span>
      </div>
      <p class="text-sm text-emerald-600 mt-1 font-medium">
        <%= (@vs_sp500 || 0) >= 0 ? 'Beating' : 'Trailing' %> market by <%= (@vs_sp500 || 0).abs.round(1) %>%
      </p>
    <% end %>

    <%= ui_card class: "p-6" do %>
      <p class="text-gray-500 text-sm font-medium">Day Gain</p>
      <div class="flex items-baseline gap-2 mt-2">
        <h2 class="text-3xl font-bold text-gray-900">$1,240</h2>
        <span class="text-sm text-emerald-600 font-medium">+3.4%</span>
      </div>
      <p class="text-sm text-gray-400 mt-1">
        Today's change
      </p>
    <% end %>
  </div>

  <!-- Portfolio Performance Chart -->
  <%= ui_card class: "p-6", data: { controller: "portfolio-chart" } do %>
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-lg font-semibold text-gray-900">Portfolio Performance</h2>
      <div class="flex gap-2">
        <% ['1M', '3M', '6M', '1Y', 'ALL'].each do |period| %>
          <button class="px-3 py-1 text-xs font-medium rounded-full <%= period == '1Y' ? 'bg-blue-100 text-blue-700' : 'text-gray-500 hover:bg-gray-100' %>">
            <%= period %>
          </button>
        <% end %>
      </div>
    </div>
    <div class="h-72 relative">
      <canvas></canvas>
    </div>
  <% end %>

  <!-- Holdings Table -->
  <div>
    <div class="flex justify-between items-end mb-4">
      <h3 class="text-xl font-medium text-gray-900">Your assets</h3>
      <div class="flex gap-2">
         <button class="btn-secondary text-xs py-1.5 px-3">
            Add Trade
         </button>
         <button class="btn-secondary text-xs py-1.5 px-3">
            Add Holding
         </button>
         <%= button_to update_prices_portfolios_path, method: :post, class: "btn-secondary text-xs py-1.5 px-3 flex items-center" do %>
            <%= icon('arrow_up_right', size: 14, class: "mr-1") %> Update Prices
         <% end %>
      </div>
    </div>
    
    <div class="bg-white rounded-none border-t border-gray-100">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-100">
            <th class="text-left py-4 pl-2 text-sm font-medium text-gray-500">Name</th>
            <th class="text-right py-4 text-sm font-medium text-gray-500">Balance</th>
            <th class="text-right py-4 text-sm font-medium text-gray-500">Current price</th>
            <th class="text-right py-4 text-sm font-medium text-gray-500">Change</th>
            <th class="text-right py-4 text-sm font-medium text-gray-500">Allocation</th>
            <th class="w-10"></th>
          </tr>
        </thead>
        <tbody>
          <% if @holdings.any? %>
            <% @holdings.each do |h| %>
              <% 
                 current_val = h.current_value 
                 price = h.prices.order(date: :desc).first&.amount_cents.to_f / 100 rescue 0
                 price = h.average_cost if price == 0
                 
                 allocation = @portfolio_value > 0 ? (current_val / @portfolio_value * 100) : 0
                 
                 # Calculate gain/loss
                 gain_loss_pct = h.total_cost_basis > 0 ? ((current_val - h.total_cost_basis) / h.total_cost_basis * 100) : 0
              %>
              <tr class="group hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-none">
                <td class="py-4 pl-2">
                  <div class="flex items-center gap-3">
                    <div>
                      <div class="font-medium text-gray-900"><%= h.name.presence || h.ticker %></div>
                      <div class="text-xs text-gray-500"><%= h.ticker %></div>
                    </div>
                  </div>
                </td>
                <td class="text-right py-4">
                  <div class="font-medium text-gray-900"><%= number_to_currency(current_val) %></div>
                  <div class="text-xs text-gray-500"><%= h.shares %> shares</div>
                </td>
                <td class="text-right py-4">
                  <div class="font-medium text-gray-900"><%= number_to_currency(price) %></div>
                </td>
                <td class="text-right py-4">
                  <div class="font-medium <%= gain_loss_pct >= 0 ? 'text-emerald-600' : 'text-red-600' %>">
                    <%= gain_loss_pct >= 0 ? '+' : '' %><%= gain_loss_pct.round(2) %>%
                  </div>
                </td>
                <td class="text-right py-4">
                  <div class="font-medium text-gray-900"><%= allocation.round(2) %>%</div>
                </td>
                <td class="text-right py-4 pr-2">
                  <button class="p-2 hover:bg-gray-100 rounded-full text-gray-400 hover:text-gray-600">
                    <%= icon('more_vertical', size: 16) %>
                  </button>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="6" class="py-8 text-center text-gray-500">
                No holdings found. Add a trade or holding to get started.
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

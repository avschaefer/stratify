<div class="space-y-8 animate-fade-in">
  
  <!-- Cash Flow Summary Tiles -->
  <div class="grid grid-cols-3 gap-4">
    <% 
       avgs = [
         { months: 3, value: @avg_cash_flow_3_months },
         { months: 6, value: @avg_cash_flow_6_months },
         { months: 12, value: @avg_cash_flow_12_months }
       ]
    %>
    <% avgs.each do |avg| %>
      <%= ui_card class: "p-4 text-center" do %>
        <p class="text-xs font-medium text-gray-400 uppercase tracking-wider"><%= avg[:months] %> Month Avg Flow</p>
        <p class="text-xl font-bold text-gray-900 mt-1"><%= number_to_currency(avg[:value] || 0, precision: 0) %></p>
      <% end %>
    <% end %>
  </div>

  <!-- Cash Flow Chart -->
  <%= ui_card class: "p-6", data: { controller: "accounts-charts" } do %>
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-lg font-semibold text-gray-900">Net Savings Cash Flow</h2>
    </div>
    <div class="h-64 relative">
      <canvas></canvas>
    </div>
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Cash Accounts -->
    <%= ui_card class: "overflow-hidden" do %>
      <div class="p-6 border-b border-gray-100 flex justify-between items-center">
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Cash Accounts</h3>
          <%= link_to "New Account", new_account_path(account_type: 'checking'), class: "btn-primary text-xs py-1.5 px-3" %>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
          <tbody class="divide-y divide-gray-100">
            <% cash_accounts = @accounts.select { |a| ['checking', 'savings'].include?(a.account_type) } %>
            <% if cash_accounts.any? %>
              <% cash_accounts.each do |acc| %>
                <% current_balance = acc.balances.order(balance_date: :desc).first&.amount_cents.to_f / 100 rescue 0 %>
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4">
                    <h4 class="font-bold text-gray-900"><%= acc.name %></h4>
                    <p class="text-sm text-gray-500"><%= acc.name.split(' ').first %> â€¢ <%= acc.account_type.capitalize %></p>
                  </td>
                  <td class="px-6 py-4 text-right">
                    <p class="text-lg font-bold text-gray-900"><%= number_to_currency(current_balance) %></p>
                    <p class="text-xs text-gray-400">Updated today</p>
                  </td>
                  <td class="px-6 py-4 text-right w-24">
                     <div class="flex flex-col gap-1 items-end">
                        <%= link_to "Edit Account", edit_account_path(acc), class: "text-gray-400 hover:text-blue-600 font-medium text-xs" %>
                        <%= link_to "Edit Balances", account_balances_path(acc), class: "text-gray-400 hover:text-blue-600 font-medium text-xs" %>
                     </div>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No cash accounts found.</td></tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <!-- Credit Cards -->
    <%= ui_card class: "overflow-hidden" do %>
      <div class="p-6 border-b border-gray-100 flex justify-between items-center">
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Credit Cards</h3>
          <%= link_to "New Account", new_account_path(account_type: 'credit_card'), class: "btn-primary text-xs py-1.5 px-3" %>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
          <tbody class="divide-y divide-gray-100">
            <% credit_accounts = @accounts.select { |a| a.account_type == 'credit_card' } %>
             <% if credit_accounts.any? %>
              <% credit_accounts.each do |acc| %>
                <% current_balance = acc.balances.order(balance_date: :desc).first&.amount_cents.to_f / 100 rescue 0 %>
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4">
                    <h4 class="font-bold text-gray-900"><%= acc.name %></h4>
                    <p class="text-sm text-gray-500"><%= acc.name.split(' ').first %></p>
                  </td>
                  <td class="px-6 py-4 text-right">
                    <p class="text-lg font-bold text-gray-900"><%= number_to_currency(current_balance.abs) %></p>
                    <p class="text-xs text-gray-400">Current Balance</p>
                  </td>
                   <td class="px-6 py-4 text-right w-24">
                     <div class="flex flex-col gap-1 items-end">
                        <%= link_to "Edit Account", edit_account_path(acc), class: "text-gray-400 hover:text-blue-600 font-medium text-xs" %>
                        <%= link_to "Edit Balances", account_balances_path(acc), class: "text-gray-400 hover:text-blue-600 font-medium text-xs" %>
                     </div>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No credit cards found.</td></tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
</div>

<div class="page-header d-flex justify-content-between align-items-start mb-4">
  <div>
    <h1>Accounts</h1>
    <p class="text-muted mb-0">Track your savings and checking accounts</p>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newAccountModal">
    <i class="bi bi-plus-circle"></i> New Account
  </button>
</div>

<!-- Savings Chart -->
<div class="card mb-4">
  <div class="card-glow"></div>
  <!-- Card: Top Section (Title) -->
  <div class="card-header">
    <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Savings & Spending Over Time</h2>
    <p class="text-muted mb-0 text-sm mt-1">Track your savings, spending, and net savings</p>
  </div>
  <!-- Card: Bottom Section (Chart) -->
  <div class="card-body">
    <div id="savingsChartContainer" style="position: relative; width: 100%; height: 400px; overflow: hidden; background: #0a0a0a; margin-bottom: 1rem;">
      <div id="savingsChart" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></div>
    </div>
    
    <!-- Controls below chart -->
    <div class="chart-controls-container">
      <!-- Series Group -->
      <div class="chart-control-group">
        <label class="chart-control-label">Series</label>
        <div class="chart-button-group">
          <button type="button" class="chart-button-toggle active" data-series="savings" id="btnSavings">
            Savings
          </button>
          <button type="button" class="chart-button-toggle active" data-series="spending" id="btnSpending">
            Spending
          </button>
          <button type="button" class="chart-button-toggle active" data-series="net_savings" id="btnNetSavings">
            Net Savings
          </button>
        </div>
      </div>
      
      <!-- Chart Type Group -->
      <div class="chart-control-group">
        <label class="chart-control-label">Chart Type</label>
        <div class="chart-button-group">
          <button type="button" class="chart-button-toggle active" data-chart-type="area" id="btnArea">
            Area
          </button>
          <button type="button" class="chart-button-toggle" data-chart-type="line" id="btnLine">
            Line
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Account Summary -->
<div class="card">
  <div class="card-glow"></div>
  <!-- Card: Top Section (Title) -->
  <div class="card-header">
    <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Account Summary</h2>
    <p class="text-muted mb-0 text-sm mt-1">Monthly balance overview</p>
  </div>
  <!-- Card: Bottom Section (Content) -->
  <div class="card-body">
    <% if @accounts.any? %>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Account</th>
              <th><%= 2.months.ago.strftime('%B %Y') %></th>
              <th><%= 1.month.ago.strftime('%B %Y') %></th>
              <th><%= Date.today.strftime('%B %Y') %></th>
            </tr>
          </thead>
          <tbody>
            <!-- Net Savings Row -->
            <tr class="account-type-divider">
              <td style="padding: 0.5rem 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1); background-color: rgba(255, 255, 255, 0.02);">
                <strong style="color: #a3a3a3; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
                  Net Savings
                </strong>
              </td>
              <td style="padding: 0.5rem 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1); background-color: rgba(255, 255, 255, 0.02);">
                <div style="display: flex; flex-direction: column;">
                  <% val2 = @net_savings_2_months_ago.to_f %>
                  <span class="<%= val2 >= 0 ? '' : 'text-danger' %>" style="font-weight: 600;">
                    <%= val2 >= 0 ? '+' : '' %>$<%= number_with_delimiter(val2.round(0)) %>
                  </span>
                  <% if @net_savings_1_month_ago && @net_savings_2_months_ago %>
                    <% change = @net_savings_1_month_ago - @net_savings_2_months_ago %>
                    <% if change != 0 %>
                      <small class="<%= change >= 0 ? 'text-success' : 'text-danger' %>" style="font-size: 0.75rem;">
                        <i class="bi bi-arrow-<%= change >= 0 ? 'up' : 'down' %>"></i>
                        <%= change >= 0 ? '+' : '' %>$<%= number_with_delimiter(change.round(0)) %>
                      </small>
                    <% end %>
                  <% end %>
                </div>
              </td>
              <td style="padding: 0.5rem 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1); background-color: rgba(255, 255, 255, 0.02);">
                <div style="display: flex; flex-direction: column;">
                  <% val1 = @net_savings_1_month_ago.to_f %>
                  <span class="<%= val1 >= 0 ? '' : 'text-danger' %>" style="font-weight: 600;">
                    <%= val1 >= 0 ? '+' : '' %>$<%= number_with_delimiter(val1.round(0)) %>
                  </span>
                  <% if @net_savings_current && @net_savings_1_month_ago %>
                    <% change = @net_savings_current - @net_savings_1_month_ago %>
                    <% if change != 0 %>
                      <small class="<%= change >= 0 ? 'text-success' : 'text-danger' %>" style="font-size: 0.75rem;">
                        <i class="bi bi-arrow-<%= change >= 0 ? 'up' : 'down' %>"></i>
                        <%= change >= 0 ? '+' : '' %>$<%= number_with_delimiter(change.round(0)) %>
                      </small>
                    <% end %>
                  <% end %>
                </div>
              </td>
              <td style="padding: 0.5rem 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1); background-color: rgba(255, 255, 255, 0.02);">
                <div style="display: flex; flex-direction: column;">
                  <% valc = @net_savings_current.to_f %>
                  <span class="<%= valc >= 0 ? '' : 'text-danger' %>" style="font-weight: 600;">
                    <%= valc >= 0 ? '+' : '' %>$<%= number_with_delimiter(valc.round(0)) %>
                  </span>
                  <small class="text-muted" style="font-size: 0.75rem;">Current month</small>
                </div>
              </td>
            </tr>
            
            <% previous_section = nil %>
            <% @accounts.each do |account| %>
              <% 
                # Determine section: savings/checking = "Savings", credit_card = "Credit Cards"
                current_section = account.account_type == 'credit_card' ? 'Credit Cards' : 'Savings'
              %>
              <% if previous_section.nil? || previous_section != current_section %>
                <tr class="account-type-divider">
                  <td colspan="4" style="padding: 0.5rem 0.75rem; border-top: 1px solid rgba(255, 255, 255, 0.1); background-color: rgba(255, 255, 255, 0.02);">
                    <strong style="color: #a3a3a3; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">
                      <%= current_section %>
                    </strong>
                  </td>
                </tr>
              <% end %>
              <tr>
                <td style="padding: 0.5rem 0.75rem; background-color: rgba(255, 255, 255, 0.02);">
                  <div class="d-flex align-items-start" style="gap: 0.5rem;">
                    <%= link_to edit_savings_account_path(account), class: "btn btn-sm btn-outline-primary", style: "flex-shrink: 0;" do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                    <div>
                      <strong style="color: #fafafa;"><%= account.name %></strong>
                      <br>
                      <small class="text-muted"><%= account.account_type&.humanize %></small>
                    </div>
                  </div>
                </td>
                <td style="padding: 0.5rem 0.75rem; background-color: rgba(255, 255, 255, 0.02);">
                  <span class="<%= account.balance_2_months_ago < 0 ? 'text-danger' : '' %>" style="color: <%= account.balance_2_months_ago < 0 ? '#fca5a5' : '#e5e5e5' %>;">
                    $<%= number_with_delimiter(account.balance_2_months_ago.round(0)) %>
                  </span>
                </td>
                <td style="padding: 0.5rem 0.75rem; background-color: rgba(255, 255, 255, 0.02);">
                  <span class="<%= account.balance_1_month_ago < 0 ? 'text-danger' : '' %>" style="color: <%= account.balance_1_month_ago < 0 ? '#fca5a5' : '#e5e5e5' %>;">
                    $<%= number_with_delimiter(account.balance_1_month_ago.round(0)) %>
                  </span>
                </td>
                <td style="padding: 0.5rem 0.75rem; background-color: rgba(255, 255, 255, 0.02);">
                  <div class="d-flex align-items-center" style="gap: 0.5rem;">
                    <strong class="<%= account.balance_current < 0 ? 'text-danger' : '' %>" style="color: <%= account.balance_current < 0 ? '#fca5a5' : '#fafafa' %>;">
                      $<%= number_with_delimiter(account.balance_current.round(0)) %>
                    </strong>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editBalancesModal<%= account.id %>" style="flex-shrink: 0;">
                      <i class="bi bi-pencil"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <% previous_section = current_section %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted text-center py-5">No accounts added yet. Click "New Account" to get started.</p>
    <% end %>
  </div>
</div>

<!-- New Account Modal -->
<div class="modal" id="newAccountModal" tabindex="-1" aria-labelledby="newAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newAccountModalLabel">New Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: @account, url: savings_accounts_path, local: true do |f| %>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <%= f.label :name, "Account Name", class: "form-label" %>
                <%= f.text_field :name, class: "form-control", required: true %>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <%= f.label :account_type, "Account Type", class: "form-label" %>
                <%= f.select :account_type, options_for_select([
                  ['Savings', 'savings'],
                  ['Checking', 'checking'],
                  ['Credit Card', 'credit_card']
                ]), {}, { class: "form-select", required: true } %>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="mb-3">
                <%= f.label :notes, "Notes (optional)", class: "form-label" %>
                <%= f.text_area :notes, class: "form-control", rows: 2 %>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Add Account", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% @accounts.each do |account| %>
  <!-- Edit Balances Modal for <%= account.name %> -->
  <div class="modal" id="editBalancesModal<%= account.id %>" tabindex="-1" aria-labelledby="editBalancesModalLabel<%= account.id %>" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editBalancesModalLabel<%= account.id %>">Edit Monthly Balances - <%= account.name %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
          <% 
            # Generate list of months from 2 years ago to current month
            start_date = 24.months.ago.beginning_of_month
            end_date = Date.today.beginning_of_month
            months_list = []
            current = start_date
            while current <= end_date
              months_list << current
              current = current.next_month
            end
            
            # Get existing snapshots indexed by month
            existing_snapshots = account.monthly_snapshots.index_by { |s| s.recorded_at.beginning_of_month }
          %>
          <form id="bulkBalancesForm<%= account.id %>" data-account-id="<%= account.id %>">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th style="width: 40%; color: #e5e5e5; background-color: rgba(255, 255, 255, 0.05); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Month</th>
                  <th style="width: 60%; color: #e5e5e5; background-color: rgba(255, 255, 255, 0.05); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Balance</th>
                </tr>
              </thead>
              <tbody>
                <% months_list.reverse.each do |month_date| %>
                  <% snapshot = existing_snapshots[month_date] %>
                  <tr style="background-color: rgba(255, 255, 255, 0.02);">
                    <td style="color: #e5e5e5; padding: 0.75rem 0.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                      <strong><%= month_date.strftime('%B %Y') %></strong>
                    </td>
                    <td style="padding: 0.75rem 0.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                      <input 
                        type="hidden" 
                        name="snapshots[][recorded_at]" 
                        value="<%= month_date.strftime('%Y-%m-%d') %>"
                      >
                      <% if snapshot %>
                        <input 
                          type="hidden" 
                          name="snapshots[][id]" 
                          value="<%= snapshot.id %>"
                        >
                      <% end %>
                      <input 
                        type="number" 
                        name="snapshots[][balance]" 
                        value="<%= snapshot ? snapshot.balance : '' %>"
                        step="0.01" 
                        class="form-control form-control-sm"
                        placeholder="Enter balance"
                        style="background-color: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.2); color: #e5e5e5;"
                      >
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveBalances(<%= account.id %>)">Save All Changes</button>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
(function() {
  function saveBalances(accountId) {
    const form = document.getElementById('bulkBalancesForm' + accountId);
    const formData = new FormData(form);
    
    // Collect all snapshot data
    const snapshots = [];
    const snapshotInputs = form.querySelectorAll('input[name^="snapshots["]');
    const rows = form.querySelectorAll('tbody tr');
    
    rows.forEach((row, index) => {
      const dateInput = row.querySelector('input[name*="[recorded_at]"]');
      const idInput = row.querySelector('input[name*="[id]"]');
      const balanceInput = row.querySelector('input[name*="[balance]"]');
      
      if (dateInput && balanceInput && balanceInput.value.trim() !== '') {
        const snapshotData = {
          recorded_at: dateInput.value,
          balance: balanceInput.value
        };
        
        if (idInput && idInput.value) {
          snapshotData.id = idInput.value;
        }
        
        snapshots.push(snapshotData);
      }
    });
    
    // Send to server
    fetch(`/savings_accounts/${accountId}/bulk_update_snapshots`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'Accept': 'application/json'
      },
      body: JSON.stringify({ snapshots: snapshots })
    })
    .then(response => {
      return response.json().then(data => {
        if (!response.ok) {
          throw { data: data, status: response.status };
        }
        return data;
      });
    })
    .then(data => {
      // Close modal and reload page
      const modal = bootstrap.Modal.getInstance(document.getElementById('editBalancesModal' + accountId));
      if (modal) {
        modal.hide();
      }
      if (data.success) {
        window.location.reload();
      } else {
        alert('Error saving balances: ' + (data.errors ? data.errors.join(', ') : 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      if (error.data && error.data.errors) {
        alert('Error saving balances: ' + error.data.errors.join(', '));
      } else {
        alert('Error saving balances. Please try again.');
      }
    });
  }
  
  // Make function globally available
  window.saveBalances = saveBalances;
})();
</script>

<script>
(function() {
  let chartInstance = null;
  let allSeries = {};
  let allData = {};
  let currentSettings = {
    visibleSeries: {
      savings: true,
      spending: true,
      net_savings: true
    },
    chartType: 'area'
  };

  // Wait for Lightweight Charts to load
  function initChart() {
    const container = document.getElementById('savingsChart');
    if (!container) {
      setTimeout(initChart, 100);
      return;
    }

    const containerParent = container.parentElement;
    if (!containerParent) {
      setTimeout(initChart, 100);
      return;
    }

    requestAnimationFrame(() => {
      const containerRect = container.getBoundingClientRect();
      if (containerRect.width === 0 || containerRect.height === 0) {
        setTimeout(initChart, 100);
        return;
      }

      if (!window.LightweightCharts) {
        setTimeout(initChart, 100);
        return;
      }

      const { createChart } = window.LightweightCharts;
      const AreaSeries = window.LightweightCharts.AreaSeries;
      const LineSeries = window.LightweightCharts.LineSeries;
      
      if (!createChart || typeof createChart !== 'function') {
        setTimeout(initChart, 100);
        return;
      }

      try {
        const chart = createChart(container, {
          width: containerRect.width,
          height: containerRect.height,
          layout: {
            background: { color: '#000000' },
            textColor: '#ffffff',
            fontSize: 12
          },
          grid: {
            vertLines: { visible: false },
            horzLines: { visible: false }
          },
          crosshair: {
            mode: 1,
            vertLine: {
              color: '#4285F4',
              width: 1,
              style: 2,
              labelBackgroundColor: '#4285F4'
            },
            horzLine: {
              color: '#4285F4',
              width: 1,
              style: 2,
              labelBackgroundColor: '#4285F4'
            }
          },
          rightPriceScale: {
            borderColor: 'rgba(255, 255, 255, 0.1)',
            textColor: '#ffffff'
          },
          timeScale: {
            borderColor: 'rgba(255, 255, 255, 0.1)',
            textColor: '#ffffff'
          }
        });

        // Fetch data from server
        fetch('/savings_accounts/chart_data')
          .then(response => response.json())
          .then(data => {
            allData = {
              savings: data.savings || [],
              spending: data.spending || [],
              net_savings: data.net_savings || []
            };

            // Create series configuration - matching image style
            const seriesConfig = {
              savings: {
                title: 'Savings',
                lineColor: '#4285F4',
                topColor: 'rgba(66, 133, 244, 0.3)',
                bottomColor: 'rgba(66, 133, 244, 0.05)',
                color: '#4285F4'
              },
              spending: {
                title: 'Spending',
                lineColor: '#4285F4',
                topColor: 'rgba(66, 133, 244, 0.3)',
                bottomColor: 'rgba(66, 133, 244, 0.05)',
                color: '#4285F4'
              },
              net_savings: {
                title: 'Net Savings',
                lineColor: '#4285F4',
                topColor: 'rgba(66, 133, 244, 0.3)',
                bottomColor: 'rgba(66, 133, 244, 0.05)',
                color: '#4285F4'
              }
            };

            // Helper function to create series
            function createSeries(type, name, config) {
              if (type === 'area') {
                if (typeof chart.addAreaSeries === 'function') {
                  return chart.addAreaSeries({
                    lineColor: config.lineColor,
                    topColor: config.topColor,
                    bottomColor: config.bottomColor,
                    lineWidth: 2,
                    priceLineVisible: false,
                    lastValueVisible: true
                  });
                } else if (AreaSeries && typeof chart.addSeries === 'function') {
                  return chart.addSeries(AreaSeries, {
                    lineColor: config.lineColor,
                    topColor: config.topColor,
                    bottomColor: config.bottomColor,
                    lineWidth: 2
                  });
                }
              } else {
                if (typeof chart.addLineSeries === 'function') {
                  return chart.addLineSeries({
                    color: config.color,
                    lineWidth: 2,
                    priceLineVisible: false,
                    lastValueVisible: true
                  });
                } else if (LineSeries && typeof chart.addSeries === 'function') {
                  return chart.addSeries(LineSeries, {
                    color: config.color,
                    lineWidth: 2,
                    priceLineVisible: false,
                    lastValueVisible: true
                  });
                }
              }
              return null;
            }

            // Create all series
            Object.keys(seriesConfig).forEach(name => {
              const series = createSeries(currentSettings.chartType, name, seriesConfig[name]);
              if (series) {
                allSeries[name] = series;
              }
            });

            // Set data and visibility
            const seriesNames = ['savings', 'spending', 'net_savings'];
            
            seriesNames.forEach((name) => {
              const series = allSeries[name];
              if (!series) return;

              const isVisible = currentSettings.visibleSeries[name];
              
              if (isVisible && allData[name] && allData[name].length > 0) {
                const formattedData = allData[name].map(point => ({
                  time: point.time,
                  value: Number(point.value)
                }));
                series.setData(formattedData);
                series.applyOptions({ visible: true });
              } else {
                series.applyOptions({ visible: false });
              }
            });

            chart.timeScale().fitContent();

            // Handle resize
            const resizeObserver = new ResizeObserver((entries) => {
              for (const entry of entries) {
                const { width, height } = entry.contentRect;
                if (width > 0 && height > 0) {
                  chart.resize(width, height);
                }
              }
            });
            resizeObserver.observe(container);

            chartInstance = chart;
            window._savingsChart = chart;
            window._savingsResizeObserver = resizeObserver;
            
            setupControls(chart);
          })
          .catch(error => {
            console.error('Error loading chart data:', error);
            
            // Fallback: generate sample data
            function generateSampleData(baseValue) {
              const res = [];
              const date = new Date(Date.UTC(2018, 0, 1, 0, 0, 0, 0));
              const numberOfPoints = 500;
              
              for (let i = 0; i < numberOfPoints; ++i) {
                const time = date.getTime() / 1000;
                const value = baseValue * (1 + i * 0.001 + Math.sin(i / 10) * 0.2);
                res.push({ time, value: Math.round(value) });
                date.setUTCDate(date.getUTCDate() + 1);
              }
              return res;
            }

            allData = {
              savings: generateSampleData(55000),
              spending: generateSampleData(3000),
              net_savings: generateSampleData(52000)
            };
          });
        
      } catch (error) {
        console.error('Error initializing chart:', error);
      }
    });
  }

  // Update chart based on current settings
  function updateChart() {
    if (!chartInstance) return;

    const seriesNames = ['savings', 'spending', 'net_savings'];
    
    seriesNames.forEach((name) => {
      const series = allSeries[name];
      if (!series) return;

      const isVisible = currentSettings.visibleSeries[name];
      series.applyOptions({ visible: isVisible });
      
      if (isVisible && allData[name] && allData[name].length > 0) {
        const formattedData = allData[name].map(point => ({
          time: point.time,
          value: Number(point.value)
        }));
        series.setData(formattedData);
      }
    });

    chartInstance.timeScale().fitContent();
  }

  // Setup control event listeners
  function setupControls(chart) {
    // Series toggle buttons
    document.querySelectorAll('.chart-button-toggle[data-series]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const seriesName = e.target.dataset.series;
        const isActive = e.target.classList.contains('active');
        
        e.target.classList.toggle('active');
        currentSettings.visibleSeries[seriesName] = !isActive;
        updateChart();
      });
    });

    // Chart type buttons
    document.querySelectorAll('.chart-button-toggle[data-chart-type]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const chartType = e.target.dataset.chartType;
        
        document.querySelectorAll('.chart-button-toggle[data-chart-type]').forEach(b => {
          b.classList.remove('active');
        });
        
        e.target.classList.add('active');
        
        currentSettings.chartType = chartType;
        recreateSeries(chart);
      });
    });
  }

  // Recreate series when chart type changes
  function recreateSeries(chart) {
    const seriesConfig = {
      savings: {
        title: 'Savings',
        lineColor: '#4285F4',
        topColor: 'rgba(66, 133, 244, 0.3)',
        bottomColor: 'rgba(66, 133, 244, 0.05)',
        color: '#4285F4'
      },
      spending: {
        title: 'Spending',
        lineColor: '#4285F4',
        topColor: 'rgba(66, 133, 244, 0.3)',
        bottomColor: 'rgba(66, 133, 244, 0.05)',
        color: '#4285F4'
      },
      net_savings: {
        title: 'Net Savings',
        lineColor: '#4285F4',
        topColor: 'rgba(66, 133, 244, 0.3)',
        bottomColor: 'rgba(66, 133, 244, 0.05)',
        color: '#4285F4'
      }
    };

    const AreaSeries = window.LightweightCharts.AreaSeries;
    const LineSeries = window.LightweightCharts.LineSeries;

    // Remove existing series
    Object.values(allSeries).forEach(series => {
      try {
        chart.removeSeries(series);
      } catch (e) {
        console.error('Error removing series:', e);
      }
    });

    allSeries = {};

    // Create new series with correct type
    Object.keys(seriesConfig).forEach(name => {
      let series;
      if (currentSettings.chartType === 'area') {
        if (typeof chart.addAreaSeries === 'function') {
          series = chart.addAreaSeries({
            lineColor: seriesConfig[name].lineColor,
            topColor: seriesConfig[name].topColor,
            bottomColor: seriesConfig[name].bottomColor,
            lineWidth: 2,
            priceLineVisible: false,
            lastValueVisible: true
          });
        } else if (AreaSeries && typeof chart.addSeries === 'function') {
          series = chart.addSeries(AreaSeries, {
            lineColor: seriesConfig[name].lineColor,
            topColor: seriesConfig[name].topColor,
            bottomColor: seriesConfig[name].bottomColor,
            lineWidth: 2,
            priceLineVisible: false,
            lastValueVisible: true
          });
        }
      } else {
        if (typeof chart.addLineSeries === 'function') {
          series = chart.addLineSeries({
            color: seriesConfig[name].color,
            lineWidth: 2,
            priceLineVisible: false,
            lastValueVisible: true
          });
        } else if (LineSeries && typeof chart.addSeries === 'function') {
          series = chart.addSeries(LineSeries, {
            color: seriesConfig[name].color,
            lineWidth: 2,
            priceLineVisible: false,
            lastValueVisible: true
          });
        }
      }
      
      if (series) {
        allSeries[name] = series;
      }
    });

    updateChart();
  }

  // Cleanup function
  function cleanup() {
    if (window._savingsChart) {
      try {
        window._savingsChart.remove();
      } catch (e) {
        console.error('Error removing chart:', e);
      }
      window._savingsChart = null;
      chartInstance = null;
      allSeries = {};
    }
    if (window._savingsResizeObserver) {
      window._savingsResizeObserver.disconnect();
      window._savingsResizeObserver = null;
    }
  }

  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initChart);
  } else {
    initChart();
  }

  // Handle Turbo events
  document.addEventListener('turbo:load', function() {
    cleanup();
    setTimeout(initChart, 50);
  });
  document.addEventListener('turbo:before-cache', cleanup);
})();
</script>

<style>
  #savingsChartContainer {
    position: relative;
    width: 100%;
    height: 400px;
    overflow: hidden;
    background: #000000;
  }
  
  #savingsChart {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
  }
  
  /* Modern Chart Controls - Dark Theme */
  .chart-controls-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  @media (min-width: 768px) {
    .chart-controls-container {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  .chart-control-group {
    display: flex;
    flex-direction: column;
  }
  
  .chart-control-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #a3a3a3;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }
  
  .chart-button-group {
    display: flex;
    gap: 0.25rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.5rem;
    padding: 0.25rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .chart-button-toggle {
    flex: 1;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #a3a3a3;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    user-select: none;
    transition: all 0.15s ease;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }
  
  .chart-button-toggle:hover {
    color: #e5e5e5;
  }
  
  .chart-button-toggle.active {
    background: rgba(255, 255, 255, 0.15);
    color: #fafafa;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
  }
  
  .chart-button-toggle.active:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fafafa;
  }
</style>

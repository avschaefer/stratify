<div class="page-header mb-4">
  <h1>Settings</h1>
  <p class="text-muted mb-0">Manage your account and preferences</p>
</div>

<!-- Settings Cards Grid -->
<div class="row g-3 mb-4">
  <!-- Account (Email & Password) -->
  <div class="col-md-6 col-lg-4">
    <div class="card">
      <div class="card-glow"></div>
      <!-- Card: Top Section (Title) -->
      <div class="card-header">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Account</h2>
      </div>
      <!-- Card: Bottom Section (Form) -->
      <div class="card-body">
        <%= form_with url: update_account_settings_path, method: :post, local: true do |f| %>
          <div class="mb-3">
            <label class="form-label text-sm">Email Address</label>
            <input type="email" name="user[email]" class="form-control form-control-sm" value="<%= @user_settings.email %>" required>
          </div>
          <div class="mb-3">
            <label class="form-label text-sm">Current Password</label>
            <input type="password" name="current_password" class="form-control form-control-sm" placeholder="Enter current password">
            <small class="text-muted text-xs">Required only if changing password</small>
          </div>
          <div class="mb-3">
            <label class="form-label text-sm">New Password</label>
            <input type="password" name="new_password" class="form-control form-control-sm" placeholder="Enter new password">
            <small class="text-muted text-xs">Leave blank to keep current password</small>
          </div>
          <div class="mb-4">
            <label class="form-label text-sm">Confirm New Password</label>
            <input type="password" name="password_confirmation" class="form-control form-control-sm" placeholder="Confirm new password">
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-sm">Update Account</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Preferences -->
  <div class="col-md-6 col-lg-4">
    <div class="card">
      <div class="card-glow"></div>
      <!-- Card: Top Section (Title) -->
      <div class="card-header">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Preferences</h2>
      </div>
      <!-- Card: Bottom Section (Form) -->
      <div class="card-body">
        <%= form_with url: settings_path, method: :patch, local: true do |f| %>
          <div class="mb-3">
            <label class="form-label text-sm">Currency</label>
            <select name="user[currency]" class="form-select form-select-sm">
              <option value="USD" <%= 'selected' if @user_settings.currency == 'USD' || @user_settings.currency.nil? %>>USD ($)</option>
              <option value="EUR" <%= 'selected' if @user_settings.currency == 'EUR' %>>EUR (€)</option>
              <option value="GBP" <%= 'selected' if @user_settings.currency == 'GBP' %>>GBP (£)</option>
              <option value="CAD" <%= 'selected' if @user_settings.currency == 'CAD' %>>CAD ($)</option>
              <option value="AUD" <%= 'selected' if @user_settings.currency == 'AUD' %>>AUD ($)</option>
              <option value="JPY" <%= 'selected' if @user_settings.currency == 'JPY' %>>JPY (¥)</option>
              <option value="CHF" <%= 'selected' if @user_settings.currency == 'CHF' %>>CHF</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label text-sm">Timezone</label>
            <select name="user[timezone]" class="form-select form-select-sm">
              <option value="America/New_York" <%= 'selected' if @user_settings.timezone == 'America/New_York' || @user_settings.timezone.nil? %>>Eastern Time (ET)</option>
              <option value="America/Chicago" <%= 'selected' if @user_settings.timezone == 'America/Chicago' %>>Central Time (CT)</option>
              <option value="America/Denver" <%= 'selected' if @user_settings.timezone == 'America/Denver' %>>Mountain Time (MT)</option>
              <option value="America/Los_Angeles" <%= 'selected' if @user_settings.timezone == 'America/Los_Angeles' %>>Pacific Time (PT)</option>
              <option value="America/Phoenix" <%= 'selected' if @user_settings.timezone == 'America/Phoenix' %>>Arizona Time</option>
              <option value="America/Anchorage" <%= 'selected' if @user_settings.timezone == 'America/Anchorage' %>>Alaska Time</option>
              <option value="Pacific/Honolulu" <%= 'selected' if @user_settings.timezone == 'Pacific/Honolulu' %>>Hawaii Time</option>
              <option value="Europe/London" <%= 'selected' if @user_settings.timezone == 'Europe/London' %>>London (GMT)</option>
              <option value="Europe/Paris" <%= 'selected' if @user_settings.timezone == 'Europe/Paris' %>>Paris (CET)</option>
              <option value="Asia/Tokyo" <%= 'selected' if @user_settings.timezone == 'Asia/Tokyo' %>>Tokyo (JST)</option>
              <option value="Asia/Hong_Kong" <%= 'selected' if @user_settings.timezone == 'Asia/Hong_Kong' %>>Hong Kong (HKT)</option>
              <option value="Australia/Sydney" <%= 'selected' if @user_settings.timezone == 'Australia/Sydney' %>>Sydney (AEDT)</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="form-label text-sm">Date Format</label>
            <select name="user[date_format]" class="form-select form-select-sm">
              <option value="MM/DD/YYYY" <%= 'selected' if @user_settings.date_format == 'MM/DD/YYYY' || @user_settings.date_format.nil? %>>MM/DD/YYYY</option>
              <option value="DD/MM/YYYY" <%= 'selected' if @user_settings.date_format == 'DD/MM/YYYY' %>>DD/MM/YYYY</option>
              <option value="YYYY-MM-DD" <%= 'selected' if @user_settings.date_format == 'YYYY-MM-DD' %>>YYYY-MM-DD</option>
              <option value="DD.MM.YYYY" <%= 'selected' if @user_settings.date_format == 'DD.MM.YYYY' %>>DD.MM.YYYY</option>
            </select>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Data Export -->
  <div class="col-md-6 col-lg-4">
    <div class="card">
      <div class="card-glow"></div>
      <!-- Card: Top Section (Title) -->
      <div class="card-header">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Data Export</h2>
      </div>
      <!-- Card: Bottom Section (Content) -->
      <div class="card-body">
        <p class="text-muted mb-4 text-sm">Export your financial data for backup or analysis</p>
        <%= button_to export_data_settings_path, method: :post, class: "btn btn-primary btn-sm w-100" do %>
          <i class="bi bi-download"></i> Export Data
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Export History -->
<% if @data_files.any? %>
  <div class="card mb-4">
    <div class="card-glow"></div>
    <!-- Card: Top Section (Title) -->
    <div class="card-header">
      <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Export History</h2>
    </div>
    <!-- Card: Bottom Section (Content) -->
    <div class="card-body">
      <p class="text-muted mb-4 text-sm">Previously exported data files</p>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Exported</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @data_files.each do |file| %>
              <tr>
                <td><%= file.filename %></td>
                <td><%= file.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
                <td>
                  <%= link_to download_data_file_settings_path(id: file.id), class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-download"></i> Download
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<!-- Delete Account - Full Width at Bottom -->
<% confirm_message = "Are you sure? This will permanently delete your account and all data. This action cannot be undone." %>
<div class="card mb-4" style="border: 2px solid rgba(239, 68, 68, 0.3);">
  <div class="card-glow"></div>
  <!-- Card: Top Section (Title) -->
  <div class="card-header" style="background-color: rgba(239, 68, 68, 0.1); border-bottom-color: rgba(239, 68, 68, 0.3);">
    <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0; color: #fca5a5;">Delete Account</h2>
  </div>
  <!-- Card: Bottom Section (Content) -->
  <div class="card-body">
    <p style="color: #e5e5e5; margin-bottom: 1rem;"><strong style="color: #fca5a5;">Warning:</strong> Deleting your account will permanently remove all your data including portfolios, loans, savings accounts, and all other financial information. This action cannot be undone.</p>
    <%= form_with url: destroy_account_settings_path,
                  method: :delete,
                  local: true,
                  data: {
                    turbo_confirm: confirm_message
                  } do |f| %>
      <div class="row align-items-end">
        <div class="col-md-8">
          <div class="mb-3 mb-md-0">
            <label class="form-label text-sm">Enter your password to confirm</label>
            <input type="password" name="password" class="form-control" placeholder="Enter password to confirm deletion" required>
          </div>
        </div>
        <div class="col-md-4">
          <button type="submit"
                  class="btn btn-danger w-100"
                  data-turbo-confirm="<%= confirm_message %>">Delete Account</button>
        </div>
      </div>
    <% end %>
  </div>
</div>

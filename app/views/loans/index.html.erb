<div class="page-header d-flex justify-content-between align-items-start mb-4">
  <div>
    <h1>Loans</h1>
    <p class="text-muted mb-0">Calculate and track your loans</p>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newLoanModal">
    <i class="bi bi-plus-circle"></i> New Loan
  </button>
</div>

<div class="mb-4">
  <h2 class="text-2xl font-semibold text-gray-800">Your Loans</h2>
</div>

<div class="row">
  <% if @loans.any? %>
    <% @loans.each do |loan| %>
      <div class="col-md-4 mb-4">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <!-- Card: Top Section (Details) -->
          <div class="p-6">
            <!-- Card Header: Title & Actions -->
            <div class="flex justify-between items-start mb-6">
              <div>
                <h2 class="text-xl font-bold text-gray-900"><%= loan.name rescue 'N/A' %></h2>
                <!-- Wrapped pills in a flex container -->
                <div class="flex items-center space-x-2 mt-2">
                  <span class="inline-block bg-blue-100 text-blue-700 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                    <%= (loan.rate_type rescue 'apr')&.upcase %>
                  </span>
                  <% if loan.payment_frequency == 'monthly' %>
                    <span class="inline-block bg-blue-100 text-blue-700 text-xs font-semibold px-2.5 py-0.5 rounded-full">Fixed</span>
                  <% end %>
                </div>
              </div>
              <!-- Action Buttons -->
              <div class="flex space-x-1">
                <%= link_to edit_loan_path(loan), class: "p-2 rounded-lg text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition-colors" do %>
                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                  </svg>
                <% end %>
                <% confirm_message = "Are you sure you want to delete this loan?" %>
                <%= button_to loan_path(loan),
                    method: :delete,
                    class: "p-2 rounded-lg text-gray-400 hover:bg-red-100 hover:text-red-600 transition-colors",
                    aria: { label: "Delete loan" },
                    title: "Delete loan",
                    data: { turbo_confirm: confirm_message } do %>
                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                  </svg>
                <% end %>
              </div>
            </div>

            <!-- Details List -->
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-sm text-gray-500">Principal</span>
                <span class="text-sm font-medium text-gray-900">$<%= number_with_delimiter((loan.principal rescue 0).round(0)) %></span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-500">Interest Rate</span>
                <span class="text-sm font-medium text-gray-900"><%= loan.interest_rate rescue 0 %>%</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-500">Term</span>
                <span class="text-sm font-medium text-gray-900"><%= loan.term_years rescue 0 %> years</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-500">Payment Frequency</span>
                <span class="text-sm font-medium text-gray-900"><%= (loan.payment_frequency rescue 'monthly')&.humanize %></span>
              </div>
            </div>
          </div>

          <!-- Card: Bottom Section (Summary) -->
          <div class="bg-gray-50 p-6">
            <div class="space-y-4">
              <div class="flex justify-between">
                <span class="text-sm text-gray-500">Total Interest</span>
                <span class="text-sm font-medium text-gray-900">$<%= number_with_delimiter((loan.total_interest rescue 0).round(0)) %></span>
              </div>
              <!-- Highlighted Monthly Payment -->
              <div class="flex justify-between items-center">
                <span class="text-lg font-semibold text-gray-800">Monthly Payment</span>
                <span class="text-xl font-bold text-blue-600">$<%= number_with_delimiter((loan.monthly_payment rescue 0).round(0)) %></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="col-12">
      <p class="text-muted text-center py-5">No loans saved yet. Click "New Loan" to get started.</p>
    </div>
  <% end %>
</div>

<!-- Loan Calculator Section -->
<div class="bg-white rounded-2xl shadow-xl overflow-hidden mt-4">
  <!-- Card: Top Section (Title) -->
  <div class="bg-gray-50 p-6 border-b border-gray-200">
    <h2 class="text-xl font-bold text-gray-900">Loan Calculator</h2>
  </div>
  <!-- Card: Bottom Section (Content) -->
  <div class="p-6">
    <!-- Guide Section -->
    <div class="mb-4">
      <h6 class="mb-3"><i class="bi bi-info-circle"></i> Understanding Loan Terms</h6>
      <div class="mb-3">
        <strong>Key Concepts:</strong>
        <ul class="mb-0 mt-2">
          <li><strong>APR (Annual Percentage Rate):</strong> The annual interest rate charged on the loan, not accounting for compounding.</li>
          <li><strong>APY (Annual Percentage Yield):</strong> The actual annual rate including compounding effects. APY is typically higher than APR for the same interest rate.</li>
          <li><strong>Payment Frequency:</strong> How often you make payments (weekly, bi-weekly, monthly, quarterly). More frequent payments can reduce total interest paid.</li>
          <li><strong>Compounding Period:</strong> How often interest is calculated and added to the principal (daily, monthly, quarterly, annually). More frequent compounding increases the effective interest rate.</li>
          <li><strong>Periodic Payment:</strong> The amount you pay each payment period, including both principal and interest.</li>
        </ul>
      </div>
      <div class="alert mb-0" style="background-color: var(--active-bg); border-color: var(--primary-color); color: var(--primary-color);">
        <small><strong>Tip:</strong> If your loan documents specify APY, select "APY" as the rate type. The calculator will convert it to APR for accurate payment calculations. More frequent payments and compounding periods can significantly affect your total interest paid.</small>
      </div>
    </div>
    
    <hr class="mb-4">
    
    <form id="loanCalculator">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Loan Amount</label>
            <input type="number" id="principal" class="form-control" step="0.01" required>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Interest Rate (%)</label>
            <input type="number" id="interest_rate" class="form-control" step="0.01" required>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">Rate Type</label>
            <select id="rate_type" class="form-select" required>
              <option value="apr">APR</option>
              <option value="apy">APY</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">Term (years)</label>
            <input type="number" id="term_years" class="form-control" step="0.25" required>
          </div>
        </div>
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">Payment Frequency</label>
            <select id="payment_frequency" class="form-select" required>
              <option value="monthly">Monthly</option>
              <option value="biweekly">Bi-weekly</option>
              <option value="weekly">Weekly</option>
              <option value="quarterly">Quarterly</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">Compounding Period</label>
            <select id="compounding_period" class="form-select" required>
              <option value="daily">Daily</option>
              <option value="monthly" selected>Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="annually">Annually</option>
            </select>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <button type="submit" class="btn btn-primary">Calculate</button>
        </div>
      </div>
    </form>
    
    <div id="loanResults" class="mt-4" style="display: none;">
      <hr>
      <div class="row">
        <div class="col-md-6">
          <h6>Loan Summary:</h6>
          <div class="d-flex justify-content-between mb-2">
            <span>Total Principal:</span>
            <strong id="totalPrincipal">$0.00</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Total Interest:</span>
            <strong class="text-danger" id="totalInterest">$0.00</strong>
          </div>
          <div class="d-flex justify-content-between mb-3">
            <span>Total Paid:</span>
            <strong id="totalAmount">$0.00</strong>
          </div>
        </div>
        <div class="col-md-6">
          <h6>Payment Breakdown:</h6>
          <div class="d-flex justify-content-between mb-2">
            <span>Periodic Payment:</span>
            <strong id="periodicPaymentRight">$0.00</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Principal per Payment:</span>
            <strong id="principalPerPayment">$0.00</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Interest per Payment:</span>
            <strong class="text-danger" id="interestPerPayment">$0.00</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span># Periods:</span>
            <strong id="totalPayments">0</strong>
          </div>
          <div class="d-flex justify-content-between mb-3">
            <span>Effective Rate:</span>
            <strong id="effectiveRate">0.00%</strong>
          </div>
        </div>
      </div>
      
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <button class="btn btn-sm btn-outline-secondary" id="toggleAmortization">Show Amortization Schedule</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveLoanModal" id="saveLoanBtn">
          <i class="bi bi-save"></i> Save Loan
        </button>
      </div>
      <div id="amortizationSchedule" class="mt-3" style="display: none;">
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Payment #</th>
                  <th>Payment Amount</th>
                  <th>Principal</th>
                  <th>Interest</th>
                  <th>Remaining Balance</th>
                </tr>
              </thead>
              <tbody id="amortizationTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Loan Modal -->
<div class="modal fade" id="newLoanModal" tabindex="-1" aria-labelledby="newLoanModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newLoanModalLabel">New Loan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: @loan, local: true do |f| %>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <%= f.label :name, "Loan Name", class: "form-label" %>
                <%= f.text_field :name, class: "form-control", required: true %>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <%= f.label :principal, "Loan Amount", class: "form-label" %>
                <%= f.number_field :principal, step: 0.01, class: "form-control", required: true %>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <%= f.label :interest_rate, "Interest Rate (%)", class: "form-label" %>
                <%= f.number_field :interest_rate, step: 0.01, class: "form-control", required: true %>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <%= f.label :rate_type, "Rate Type", class: "form-label" %>
                <%= f.select :rate_type, options_for_select([
                  ['APR', 'apr'],
                  ['APY', 'apy']
                ]), {}, { class: "form-select" } %>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <%= f.label :term_years, "Term (years)", class: "form-label" %>
                <%= f.number_field :term_years, step: 0.25, class: "form-control", required: true %>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <%= f.label :payment_frequency, "Payment Frequency", class: "form-label" %>
                <%= f.select :payment_frequency, options_for_select([
                  ['Monthly', 'monthly'],
                  ['Bi-weekly', 'biweekly'],
                  ['Weekly', 'weekly'],
                  ['Quarterly', 'quarterly']
                ]), {}, { class: "form-select", required: true } %>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <%= f.label :compounding_period, "Compounding Period", class: "form-label" %>
                <%= f.select :compounding_period, options_for_select([
                  ['Daily', 'daily'],
                  ['Monthly', 'monthly'],
                  ['Quarterly', 'quarterly'],
                  ['Annually', 'annually']
                ]), {}, { class: "form-select" } %>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="mb-3">
                <%= f.label :notes, "Notes", class: "form-label" %>
                <%= f.text_field :notes, class: "form-control" %>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Save Loan", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Save Calculated Loan Modal -->
<div class="modal fade" id="saveLoanModal" tabindex="-1" aria-labelledby="saveLoanModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="saveLoanModalLabel">Save Calculated Loan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= form_with model: @loan, local: true, id: 'saveCalculatedLoanForm' do |f| %>
          <% if @loan.errors.any? %>
            <div class="alert alert-danger">
              <ul class="mb-0">
                <% @loan.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <div class="mb-3">
            <%= f.label :name, "Loan Name", class: "form-label" %>
            <%= f.text_field :name, class: "form-control", required: true, id: "saveLoanName" %>
          </div>
          
          <div class="mb-3">
            <%= f.label :notes, "Notes (optional)", class: "form-label" %>
            <%= f.text_field :notes, class: "form-control", id: "saveLoanNotes" %>
          </div>
          
          <!-- Hidden fields for calculated values -->
          <%= f.hidden_field :principal, id: "saveLoanPrincipal" %>
          <%= f.hidden_field :interest_rate, id: "saveLoanInterestRate" %>
          <%= f.hidden_field :rate_type, id: "saveLoanRateType" %>
          <%= f.hidden_field :term_years, id: "saveLoanTermYears" %>
          <%= f.hidden_field :payment_frequency, id: "saveLoanPaymentFrequency" %>
          <%= f.hidden_field :compounding_period, id: "saveLoanCompoundingPeriod" %>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Save Loan", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  // Store calculator values globally
  let calculatorValues = {};
  
  document.getElementById('loanCalculator').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
      principal: parseFloat(document.getElementById('principal').value),
      interest_rate: parseFloat(document.getElementById('interest_rate').value),
      rate_type: document.getElementById('rate_type').value,
      term_years: parseFloat(document.getElementById('term_years').value),
      payment_frequency: document.getElementById('payment_frequency').value,
      compounding_period: document.getElementById('compounding_period').value
    };
    
    // Store values for saving
    calculatorValues = formData;
    
    fetch('<%= calculate_loans_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify(formData)
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => Promise.reject(err));
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }
      
      document.getElementById('totalPrincipal').textContent = '$' + Math.round(data.total_principal || 0).toLocaleString('en-US');
      document.getElementById('totalInterest').textContent = '$' + Math.round(data.total_interest || 0).toLocaleString('en-US');
      document.getElementById('totalAmount').textContent = '$' + Math.round(data.total_amount || 0).toLocaleString('en-US');
      
      // Right column
      document.getElementById('periodicPaymentRight').textContent = '$' + Math.round(data.periodic_payment || 0).toLocaleString('en-US');
      document.getElementById('principalPerPayment').textContent = '$' + Math.round(data.principal_per_payment || 0).toLocaleString('en-US');
      document.getElementById('interestPerPayment').textContent = '$' + Math.round(data.interest_per_payment || 0).toLocaleString('en-US');
      document.getElementById('totalPayments').textContent = data.total_payments || 0;
      
      // Handle effective_rate - convert to number if needed
      const effectiveRate = parseFloat(data.effective_rate) || 0;
      document.getElementById('effectiveRate').textContent = effectiveRate.toFixed(2) + '%';
      
      // Build amortization schedule
      if (data.amortization_schedule) {
        const tbody = document.getElementById('amortizationTableBody');
        tbody.innerHTML = '';
        data.amortization_schedule.forEach((payment, index) => {
          const row = tbody.insertRow();
          row.insertCell(0).textContent = index + 1;
          row.insertCell(1).textContent = '$' + Math.round(payment.payment_amount).toLocaleString('en-US');
          row.insertCell(2).textContent = '$' + Math.round(payment.principal).toLocaleString('en-US');
          row.insertCell(3).textContent = '$' + Math.round(payment.interest).toLocaleString('en-US');
          row.insertCell(4).textContent = '$' + Math.round(payment.balance).toLocaleString('en-US');
        });
      }
      
      document.getElementById('loanResults').style.display = 'block';
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error calculating loan: ' + (error.error || error.message || 'Unknown error'));
    });
  });
  
  document.getElementById('toggleAmortization').addEventListener('click', function() {
    const schedule = document.getElementById('amortizationSchedule');
    if (schedule.style.display === 'none') {
      schedule.style.display = 'block';
      this.textContent = 'Hide Amortization Schedule';
    } else {
      schedule.style.display = 'none';
      this.textContent = 'Show Amortization Schedule';
    }
  });
  
  // Populate save loan form when modal is opened
  document.getElementById('saveLoanBtn').addEventListener('click', function() {
    if (calculatorValues.principal) {
      document.getElementById('saveLoanPrincipal').value = calculatorValues.principal;
      document.getElementById('saveLoanInterestRate').value = calculatorValues.interest_rate;
      document.getElementById('saveLoanRateType').value = calculatorValues.rate_type;
      document.getElementById('saveLoanTermYears').value = calculatorValues.term_years;
      document.getElementById('saveLoanPaymentFrequency').value = calculatorValues.payment_frequency;
      document.getElementById('saveLoanCompoundingPeriod').value = calculatorValues.compounding_period;
    }
  });
</script>

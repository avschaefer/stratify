<div class="page-header d-flex justify-content-between align-items-start mb-4">
  <div>
    <h1>Dashboard</h1>
    <p>Overview of your financial health</p>
  </div>
  <div class="d-flex gap-2 flex-wrap">
    <%= link_to export_excel_dashboard_index_path, class: "btn btn-primary" do %>
      <i class="bi bi-download"></i> Export to Excel
    <% end %>
    <%= link_to export_pdf_dashboard_index_path, class: "btn btn-primary" do %>
      <i class="bi bi-file-pdf"></i> Export to PDF
    <% end %>
  </div>
</div>

<!-- Dashboard Metrics -->
<div class="card mb-4">
  <div class="card-glow"></div>
  <!-- Card: Top Section (Title) -->
  <div class="card-header">
    <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Financial Overview</h2>
  </div>
  <!-- Card: Bottom Section (Metrics) -->
  <div class="card-body">
    <div class="metrics-grid">
      <!-- Net Worth -->
      <div class="metric-tile">
        <div class="metric-label">Net Worth</div>
        <div class="metric-value">$<%= number_with_delimiter(@net_worth.round(0)) %></div>
        <% if @net_worth_trend.present? %>
          <div class="metric-subtext" style="color: <%= @net_worth_trend >= 0 ? '#6ee7b7' : '#fca5a5' %>;">
            <%= @net_worth_trend >= 0 ? '+' : '' %><%= number_with_precision(@net_worth_trend, precision: 0) %>% this year
          </div>
        <% end %>
      </div>
      
      <!-- Total Assets -->
      <div class="metric-tile">
        <div class="metric-label">Total Assets</div>
        <div class="metric-value">$<%= number_with_delimiter(@total_assets.round(0)) %></div>
        <% if @assets_trend.present? %>
          <div class="metric-subtext" style="color: <%= @assets_trend >= 0 ? '#059669' : '#dc2626' %>;">
            <%= @assets_trend >= 0 ? '+' : '' %><%= number_with_precision(@assets_trend, precision: 0) %>% this year
          </div>
        <% end %>
      </div>
      
      <!-- Total Liabilities -->
      <div class="metric-tile">
        <div class="metric-label">Total Liabilities</div>
        <div class="metric-value">$<%= number_with_delimiter(@total_liabilities.round(0)) %></div>
        <% if @liabilities_trend.present? %>
          <div class="metric-subtext" style="color: <%= @liabilities_trend >= 0 ? '#059669' : '#dc2626' %>;">
            <%= @liabilities_trend >= 0 ? '+' : '' %><%= number_with_precision(@liabilities_trend, precision: 0) %>% this year
          </div>
        <% end %>
      </div>
      
      <!-- Net Monthly Savings -->
      <div class="metric-tile">
        <div class="metric-label">Net Monthly Savings</div>
        <div class="metric-value">$<%= number_with_delimiter(@monthly_savings.round(0)) %></div>
        <div class="metric-subtext">Average</div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card mb-4">
      <div class="card-glow"></div>
      <!-- Card: Top Section (Title) -->
      <div class="card-header">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Asset Allocation</h2>
      </div>
      <!-- Card: Bottom Section (Content) -->
      <div class="card-body">
        <% if @asset_allocation.any? %>
          <div class="row">
            <div class="col-md-6">
              <!-- Pie Chart -->
              <canvas id="assetAllocationChart" style="max-height: 400px;"></canvas>
            </div>
            <div class="col-md-6">
              <!-- Legend/List -->
              <div class="mb-3">
                <% total_assets = @asset_allocation.values.sum %>
                <% @asset_allocation.sort_by { |_, v| -v }.each do |asset_type, value| %>
                  <% percentage = total_assets > 0 ? (value / total_assets * 100) : 0 %>
                  <div class="mb-2">
                    <div class="d-flex justify-content-between mb-1">
                      <span class="text-sm" style="color: #e5e5e5;"><%= asset_type %></span>
                      <span class="text-sm font-medium" style="color: #fafafa;"><%= number_with_precision(percentage, precision: 1) %>%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar" role="progressbar" style="width: <%= percentage %>%">
                        $<%= number_with_delimiter(value.round(0)) %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% else %>
          <p class="text-muted text-center py-5">Add investments to see allocation.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if @asset_allocation.any? %>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
  const ctx = document.getElementById('assetAllocationChart');
  if (!ctx) return;
  
  const assetData = <%= @asset_allocation.to_json.html_safe %>;
  const labels = Object.keys(assetData);
  const values = Object.values(assetData);
  const total = values.reduce((a, b) => a + b, 0);
  
  // Color scheme for different asset types
  const colorMap = {
    'Stocks': '#3b82f6',
    'Bonds': '#10b981',
    'Crypto': '#f59e0b',
    'Mortgage': '#ef4444',
    'Auto Loan': '#f97316',
    'Student Loan': '#8b5cf6',
    'Credit Card': '#ec4899',
    'Personal Loan': '#6366f1',
    'Other Debt': '#64748b',
    'Other': '#94a3b8'
  };
  
  const backgroundColors = labels.map(label => colorMap[label] || '#94a3b8');
  
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels.map(label => `${label} (${((assetData[label] / total) * 100).toFixed(1)}%)`),
      datasets: [{
        data: values,
        backgroundColor: backgroundColors,
        borderColor: '#000000',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            color: '#ffffff',
            font: {
              size: 12
            },
            padding: 15
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const percentage = ((value / total) * 100).toFixed(1);
              return `${label.split(' (')[0]}: $${value.toLocaleString()} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
})();
</script>
<% end %>

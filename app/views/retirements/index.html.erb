<div class="space-y-6 animate-fade-in" data-controller="modal">
  <!-- Top Metrics -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <%= ui_card class: "p-5 text-center" do %>
      <p class="text-xs text-gray-500 uppercase font-semibold">Gap to Goal</p>
      <p class="text-2xl font-bold <%= @gap_to_goal >= 0 ? 'text-emerald-600' : 'text-blue-600' %> mt-2">
          <%= number_to_currency(@gap_to_goal.abs, precision: 0) %>
      </p>
      <p class="text-xs text-gray-400 mt-1"><%= @gap_to_goal >= 0 ? 'Surplus' : 'Remaining' %></p>
    <% end %>

    <%= ui_card class: "p-5 text-center" do %>
      <p class="text-xs text-gray-500 uppercase font-semibold">Years to Goal</p>
      <p class="text-2xl font-bold text-gray-900 mt-2"><%= @years_to_goal %> Years</p>
      <p class="text-xs text-gray-400 mt-1">Until age <%= @target_age rescue 65 %></p>
    <% end %>

    <%= ui_card class: "p-5 text-center" do %>
      <p class="text-xs text-gray-500 uppercase font-semibold">Projected Value</p>
      <p class="text-2xl font-bold text-emerald-600 mt-2"><%= number_to_currency(@projected_value, precision: 0) %></p>
      <p class="text-xs text-gray-400 mt-1">At retirement</p>
    <% end %>

    <%= ui_card class: "p-5 text-center" do %>
      <p class="text-xs text-gray-500 uppercase font-semibold">Monthly Needed</p>
      <p class="text-2xl font-bold text-gray-900 mt-2"><%= number_to_currency(@monthly_contribution_needed, precision: 0) %></p>
      <p class="text-xs text-gray-400 mt-1">To hit target</p>
    <% end %>
  </div>

  <!-- Scenarios List -->
  <div class="flex justify-between items-center">
      <h2 class="text-xl font-bold text-gray-900">Scenarios</h2>
      <button data-action="modal#open" class="btn-primary">
          Add Scenario
        </button>
  </div>
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <% if @retirements.any? %>
        <% @retirements.each do |scenario| %>
          <%= ui_card class: "p-6 hover:border-blue-300 transition-colors cursor-pointer group relative" do %>
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-gray-900 group-hover:text-blue-600 transition-colors"><%= scenario.name %></h3>
              <%= link_to "Edit", edit_retirement_path(scenario), class: "text-gray-400 hover:text-blue-600 font-medium text-xs px-2 py-1 rounded hover:bg-gray-50" %>
            </div>
            <div class="space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Retirement Date</span>
                <span class="font-medium text-gray-900"><%= (scenario.target_date rescue Date.today).year %></span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Monthly Contribution</span>
                <span class="font-medium text-gray-900"><%= number_to_currency(scenario.monthly_contribution || 0) %></span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Exp. Return Rate</span>
                <span class="font-medium text-gray-900"><%= scenario.expected_return_rate %>%</span>
              </div>
              <div class="pt-3 border-t border-gray-100 mt-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-semibold text-gray-500">Projected Total</span>
                  <% 
                     # Use the calculated projected value from the controller if it matches this scenario, 
                     # otherwise approximate it (controller logic is complex, simplifed display here)
                     is_active = (scenario == @retirements.first)
                     val = is_active ? @projected_value : (scenario.target_amount || 0)
                  %>
                  <span class="text-lg font-bold text-emerald-600"><%= number_to_currency(val, precision: 0) %></span>
                </div>
              </div>
            </div>
            
            <% unless scenario == @retirements.first %>
              <div class="mt-4 pt-2 border-t border-gray-100">
                 <%= button_to "Set as Active", set_active_retirement_path(scenario), method: :post, class: "w-full py-1.5 text-xs font-medium text-blue-600 bg-blue-50 rounded hover:bg-blue-100 transition-colors" %>
              </div>
            <% end %>
          <% end %>
        <% end %>
    <% else %>
       <div class="col-span-full text-center py-10 bg-white rounded-2xl border border-gray-200 text-gray-500">
        No retirement scenarios found.
      </div>
    <% end %>
  </div>

  <!-- New Scenario Modal -->
  <%= render 'shared/modal', title: "New Scenario", target: "dialog" do %>
    <%= form_with model: @retirement, local: true, class: "space-y-4" do |f| %>
      <div>
        <%= f.label :name, "Scenario Name", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :name, class: "input-standard", required: true %>
      </div>
      
       <div class="grid grid-cols-2 gap-4">
        <div>
          <%= f.label :target_date, "Target Retirement Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.date_field :target_date, class: "input-standard", required: true %>
        </div>
        <div>
          <%= f.label :target_amount, "Total Goal", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.number_field :target_amount, step: 0.01, class: "input-standard", required: true %>
        </div>
      </div>
      
       <div class="grid grid-cols-2 gap-4">
        <div>
          <%= f.label :current_savings, "Current Savings", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.number_field :current_savings, step: 0.01, class: "input-standard", required: true %>
        </div>
        <div>
          <%= f.label :monthly_contribution, "Monthly Contribution", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.number_field :monthly_contribution, step: 0.01, class: "input-standard", required: true %>
        </div>
      </div>
      
       <div>
         <%= f.label :expected_return_rate, "Expected Return Rate (%)", class: "block text-sm font-medium text-gray-700 mb-1" %>
         <%= f.number_field :expected_return_rate, step: 0.01, value: 7, class: "input-standard", required: true %>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <button type="button" data-action="modal#close" class="btn-secondary">Cancel</button>
        <%= f.submit "Save Scenario", class: "btn-primary cursor-pointer" %>
      </div>
    <% end %>
  <% end %>
</div>
